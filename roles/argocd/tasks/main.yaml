---
- name: Install PIP
  ansible.builtin.yum:
    name: python3-pip
    state: installed
  become: yes

- name: Install kubernetes pip package
  ansible.builtin.pip:
    name: kubernetes
    state: present
  become: yes

- name: Create argocd namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: namespace
    name: argocd
    state: present
  become: yes

- name: Install ArgoCD
  kubernetes.core.k8s:
    namespace: argocd
    src: https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
    state: present
  become: yes

- name: Create ingress
  kubernetes.core.k8s:
    state: present
    namespace: argocd
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: argocd-server-ingress
        namespace: argocd
        annotations:
          nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
          nginx.ingress.kubernetes.io/ssl-passthrough: "true"
      spec:
        ingressClassName: nginx
        rules:
        - host: argocd.apps.tomlab.awscloudqstars.nl
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: argocd-server
                  port:
                    name: https
  become: yes
